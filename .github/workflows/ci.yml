name: CI and Promote

on:
  push:
    branches:
      - dev

concurrency:
  group: promote-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  promote:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Rebase onto main, verify, and promote
        env:
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          max_attempts=3
          attempt=1

          while [ "$attempt" -le "$max_attempts" ]; do
            echo "Promotion attempt ${attempt}/${max_attempts}"
            git fetch origin main || true
            git checkout -B promote-candidate "$SHA"

            if git show-ref --verify --quiet refs/remotes/origin/main; then
              if ! git rebase origin/main; then
                git rebase --abort || true
                echo "Automatic rebase onto main failed due to conflicts."
                echo "Resolve on dev, then push dev again."
                exit 1
              fi
            fi

            npm ci
            npm test

            if git push origin HEAD:main; then
              echo "Promotion succeeded."
              exit 0
            fi

            echo "Push rejected (main advanced). Retrying..."
            attempt=$((attempt + 1))
          done

          echo "Promotion failed after ${max_attempts} attempts."
          exit 1
